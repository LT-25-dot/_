<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MTR 巴士到站時間查詢（非官方）</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; 
      max-width: 860px; 
      margin: 0 auto; 
      padding: 20px; 
      background: #f8f9fa; 
      color: #333; 
      position: relative;
    }
    .back-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      padding: 8px 16px;
      background: #c8102e;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
      z-index: 100;
      transition: background 0.2s;
    }
    .back-btn:hover { background: #a00d24; }
    h1 { color: #c8102e; text-align: center; margin-bottom: 0.4em; margin-top: 60px; }
    .subtitle { text-align: center; color: #555; margin-bottom: 1.8em; }
    .controls { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin: 1.5em 0; }
    select, button { padding: 10px 16px; font-size: 1.05rem; border-radius: 6px; border: 1px solid #ccc; }
    button { background: #c8102e; color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background: #a00d24; }
    button:disabled { background: #999; cursor: not-allowed; }
    .status { text-align: center; margin: 1em 0; color: #555; min-height: 1.4em; }
    .route-title { font-size: 1.6rem; margin: 1.2em 0 0.6em; color: #c8102e; text-align: center; }
    .bus-stop { background: white; border-radius: 8px; margin: 1.2em 0; padding: 1em 1.2em; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .stop-name { font-size: 1.25rem; font-weight: 600; margin: 0.4em 0 0.8em; color: #222; }
    .bus-item { display: grid; grid-template-columns: 1.8fr 2.8fr 1fr; gap: 8px; padding: 10px 0; border-bottom: 1px solid #eee; }
    .bus-item:last-child { border-bottom: none; }
    .bus-time { font-size: 1.35rem; font-weight: bold; color: #c8102e; }
    .bus-info { color: #555; font-size: 0.95rem; }
    .schedule { color: #2e7d32; font-size: 0.9rem; }
    .realtime { color: #d81b60; font-size: 0.9rem; }
    .footer-remark { margin-top: 2.5em; padding: 1em; background: #fff3cd; border-radius: 8px; font-size: 0.92rem; line-height: 1.45; color: #664d03; }
    .error-msg { color: #c00; text-align: center; margin: 2em 0; font-size: 1.1rem; }
    @media (max-width: 560px) { 
      .bus-item { grid-template-columns: 1fr; gap: 4px; } 
      .bus-time { margin-bottom: 4px; }
      .back-btn { position: fixed; top: 10px; left: 10px; padding: 8px 14px; font-size: 0.95rem; }
    }
  </style>
</head>
<body>

<a href="index.html" class="back-btn">← 返回</a>

<h1>MTR 巴士到站時間查詢</h1>
<p class="subtitle">（非官方工具 • 公開資料 • 2026年1月強化中文站名版）</p>

<div class="controls">
  <select id="lang">
    <option value="zh">繁體中文</option>
    <option value="en">English</option>
  </select>
  <select id="route">
    <option value="">請選擇路線…</option>
    <option value="506">506 屯門碼頭 ↔ 兆麟 / 富健花園 ↔ 屯門站</option>
    <option value="K12">K12 大埔墟站 ↔ 八號花園</option>
    <option value="K14">K14 大埔超級城 ↔ 大埔墟站</option>
    <option value="K17">K17 大埔墟站 ↔ 富善</option>
    <option value="K18">K18 大埔墟站 ↔ 廣福</option>
    <option value="K51">K51 富泰 ↔ 大欖 / 兆康站</option>
    <option value="K52">K52 悅湖山莊 ↔ 龍鼓灘 (含K52A/K52P變體)</option>
    <option value="K53">K53 屯門站 ↔ 掃管笏 (循環)</option>
    <option value="K54">K54 和田邨 ↔ 屯門市中心 (循環)</option>
    <option value="K65">K65 元朗站 ↔ 流浮山</option>
    <option value="K66">K66 朗屏 ↔ 大棠</option>
    <option value="K68">K68 元朗工業邨循環 / 各支線</option>
  </select>
  <button id="btnQuery" disabled>查詢</button>
</div>

<div class="status" id="status">請先選擇路線</div>
<div id="result"></div>
<div class="footer-remark" id="footerRemark" style="display:none"></div>

<script>
const API_URL = "https://rt.data.gov.hk/v1/transport/mtr/bus/getSchedule";

// 2026年強化中文站名映射（基於MTR官網、Moovit、Busio等2026年路線序列 + 你提供的未知ID）
const STOP_NAMES = {
  "506": {
    "506-D010": "屯門碼頭巴士總站",
    "506-D020": "碼頭花園",
    "506-D030": "湖景樓,湖王樓",
    "506-D040": "蝶翠苑蝶峰樓",
    "506-D050": "輕鐵蝴蝶站",
    "506-D060": "新屯門中心",
    "506-D070": "榮華花園",
    "506-D080": "聖彼得教堂",
    "506-D090": "輕鐵青雲站",
    "506-D100": "輕鐵建安站",
    "506-D110": "輕鐵屯門站",
    "506-D120": "LR鎮中心站",
    "506-D130": "友愛邨",
    "506-D140": "兆麟站"
  },
  "506": {
    "506-D010": "兆麟站",
    "506-D020": "友愛邨",
    "506-D030": "LR鎮中心站",
    "506-D040": "輕鐵屯門站",
    "506-D050": "輕鐵建安站",
    "506-D060": "輕鐵青雲站",
    "506-D070": "聖彼得教堂",
    "506-D080": "榮華花園",
    "506-D090": "新屯門中心",
    "506-D100": "輕鐵蝴蝶站",
    "506-D110": "蝶翠苑蝶峰樓",
    "506-D120": "湖景樓,湖王樓",
    "506-D130": "碼頭花園",
    "506-D140": "屯門碼頭巴士總站"
  },
  "506": {
    "506-D010": "富健花園",
    "506-D020": "輕鐵龍門站",
    "506-D030": "LR青雲站",
    "506-D040": "LR建安站",
    "506-D050": "屯門站巴士總站"
  },
  "K12": {
    "K12-D010": "怡豐花園",
    "K12-D020": "大埔超級城",
    "K12-D030": "蔚藍灣畔",
    "K12-D040": "大埔墟站巴士總站"
  },
  "K53": {
    "K53-D010": "屯門站巴士總站",
    "K53-D020": "屯門中央巴士總站",
    "K53-D030": "屯門官立中學",
    "K53-D040": "俊庭",
    "K53-D050": "豐收花園",
    "K53-D060": "三聖邨",
    "K53-D070": "青山灣",
    "K53-D080": "海景花園",
    "K53-D090": "餐廳灣",
    "K53-D100": "金碧海岸",
    "K53-D110": "香港黃金海岸",
    "K53-D120": "愛琴海岸",
    "K53-D130": "掃管笏變電站",
    "K53-D140": "掃管笏村",
    "K53-D150": "掃管笏",
    "K53-D160": "掃管笏路",
    "K53-D170": "昆翠路18號",
    "K53-D180": "昆翠路",
    "K53-D190": "愛琴海岸",
    "K53-D200": "香港黃金海岸",
    "K53-D210": "金碧海岸",
    "K53-D220": "餐廳灣",
    "K53-D230": "海濱臺",
    "K53-D240": "青山碼頭",
    "K53-D250": "三聖邨",
    "K53-D260": "顯福花園",
    "K53-D270": "屯門小欖政府合署",
    "K53-D280": "青山善樂園",
    "K53-D290": "智樂花園",
    "K53-D300": "屯門官立中學",
    "K53-D310": "LR城中心站"
  },
  "K54": {
    "K54-D010": "和田邨",
    "K54-D020": "青山邨",
    "K54-D030": "紫田村",
    "K54-D040": "欣田邨",
    "K54-D050": "兆康站 (北)",
    "K54-D060": "洪橋",
    "K54-D070": "屯門中央巴士總站",
    "K54-D080": "屯門鎮廣場",
    "K54-D090": "新墟街市",
    "K54-D100": "兆康站 (北)",
    "K54-D110": "兆康苑",
    "K54-D120": "欣寶路巴士總站",
    "K54-D130": "青山邨",
    "K54-D140": "和田邨"
  },
  "K58": {
    "K58-D010": "掃管笏村",
    "K58-D020": "掃管笏",
    "K58-D030": "掃管笏路",
    "K58-D040": "昆翠路18號",
    "K58-D050": "昆翠路",
    "K58-D060": "愛琴海岸",
    "K58-D070": "香港黃金海岸",
    "K58-D080": "金碧沙灘",
    "K58-D090": "餐廳海灘",
    "K58-D100": "碧堤花園",
    "K58-D110": "青山碼頭",
    "K58-D120": "三聖邨",
    "K58-D130": "屯門小欖政府合署",
    "K58-D140": "青山善樂園",
    "K58-D150": "智樂花園",
    "K58-D160": "屯門官立中學",
    "K58-D170": "LR鎮中心站",
    "K58-D180": "屯門輕鐵站",
    "K58-D190": "建安站",
    "K58-D200": "明琴站",
    "K58-D210": "石排站",
    "K58-D220": "新圍輕鐵站",
    "K58-D230": "亭景輕鐵站",
    "K58-D240": "青山田遊樂場",
    "K58-D250": "樂生樓建生邨",
    "K58-D260": "泰生樓建生邨",
    "K58-D270": "奇輪輕鐵站",
    "K58-D280": "欣田邨",
    "K58-D290": "兆康站(南)",
    "K58-D300": "麗都花園",
    "K58-D310": "嶺南大學",
    "K58-D320": "南山居",
    "K58-D330": "富泰邨巴士總站"
  },
  "K65": {
    "K65-D010": "流浮山",
    "K65-D020": "新興村",
    "K65-D030": "沙江圍",
    "K65-D040": "豐江村",
    "K65-D050": "東頭村",
    "K65-D060": "老屋村",
    "K65-D070": "石江圍",
    "K65-D080": "下村",
    "K65-D090": "沙洲嶺村",
    "K65-D100": "天盛苑",
    "K65-D110": "路環坑尾村站",
    "K65-D120": "坑尾村",
    "K65-D130": "平興巷平山",
    "K65-D140": "路環平山站",
    "K65-D150": "輕鐵瑞邊圍站",
    "K65-D160": "元朗廣場",
    "K65-D170": "元朗地標",
    "K65-D180": "谷亭街元朗",
    "K65-D190": "元朗站"
  },
  "K65": {
    "K65-D010": "元朗站",
    "K65-D020": "友善街",
    "K65-D030": "大棠路",
    "K65-D040": "康樂路",
    "K65-D050": "元朗警署",
    "K65-D060": "水邊村",
    "K65-D070": "元朗公園",
    "K65-D080": "朗邊",
    "K65-D090": "平興巷平山",
    "K65-D100": "坑尾村",
    "K65-D110": "LR坑尾村站",
    "K65-D120": "天盛苑",
    "K65-D130": "石埔路天水圍",
    "K65-D140": "沙洲嶺村",
    "K65-D150": "蝦蟀",
    "K65-D160": "石崗圍",
    "K65-D170": "老屋村",
    "K65-D180": "東頭村(南)",
    "K65-D190": "東頭村(北)",
    "K65-D200": "豐崗村",
    "K65-D210": "沙崗圍",
    "K65-D220": "新興村",
    "K65-D230": "流浮山"
  },
  "K66": {
    "K66-D010": "大棠黃泥墩村",
    "K66-D020": "大棠山路",
    "K66-D030": "大棠迴旋處",
    "K66-D040": "Wah Yuen",
    "K66-D050": "Shui Chiu San Tsuen",
    "K66-D060": "Nam Hang Pai",
    "K66-D070": "Nam Hang Tsuen",
    "K66-D080": "Hung Tso Tin Village",
    "K66-D090": "Po Shing Wai",
    "K66-D100": "Shung Ching School",
    "K66-D110": "Law Ka Yuen",
    "K66-D120": "Sham Chung Village",
    "K66-D130": "Fraser Village",
    "K66-D140": "Sereno Verde",
    "K66-D150": "Hang Heung Cake Shop",
    "K66-D160": "Manhattan Plaza",
    "K66-D170": "Citi Mall",
    "K66-D180": "安康路"
  },
  "K68": {
    "K68-D010": "Toppan Forms Card Tech Ltd",
    "K68-D020": "Nestle (HK) Ltd",
    "K68-D030": "Yuen Long Sewage Treatment Works",
    "K68-D040": "Yuen Long Industrial Estate",
    "K68-D050": "Wai Yuen Tong Medicine Building",
    "K68-D060": "TDK Manufacturing (HK) Co Ltd",
    "K68-D070": "Toppan Printing Co (HK) Ltd",
    "K68-D080": "Telford International Industries Ltd",
    "K68-D090": "Wang Chau Fuk Hing Tsuen",
    "K68-D100": "Long Ping Estate Bus Terminus",
    "K68-D110": "Yeung Uk Tsuen",
    "K68-D120": "Ping Cheong Path",
    "K68-D130": "Yuen Long Home For the Aged Blind",
    "K68-D140": "Lut Sau Hall",
    "K68-D150": "Yuen Long Theatre",
    "K68-D160": "Silver Field Garden",
    "K68-D170": "South Yuen Long Government Primary School",
    "K68-D180": "Yuen Long Park Bus Terminus",
    "K68-D190": "Park Royale",
    "K68-D200": "Villa Art Deco",
    "K68-D210": "Springdale Villas",
    "K68-D220": "Yuen Long Swimming Pool",
    "K68-D230": "Yuen Long Town Hall",
    "K68-D240": "Yuen Long Plaza",
    "K68-D250": "安寧路 on Ning Road",
    "K68-D260": "Tai Kiu Tsuen",
    "K68-D270": "Wai Chow School",
    "K68-D280": "Chu Ping House Long Ping Estate",
    "K68-D290": "Long Ping Estate Bus Terminus",
    "K68-D300": "Wang Chau Fuk Hing Tsuen",
    "K68-D310": "Yuen Long Textile Co Ltd",
    "K68-D320": "DCH Food Processing & Logistics Center",
    "K68-D330": "Yau Sang Galvanizers (Hot-Dip) Co Ltd",
    "K68-D340": "Eu Yan Sang Centre",
    "K68-D350": "Yuen Long Sewage Treatment Works",
    "K68-D360": "Nestle (HK) Ltd",
    "K68-D370": "Ushio HK Ltd"
  },
  "K73": {
    "K73-D010": "天恆邨巴士總站",
    "K73-D020": "天逸邨日潭樓",
    "K73-D030": "天逸邨日陽樓",
    "K73-D040": "天晴邨清碧樓",
    "K73-D050": "天恩邨巴士總站",
    "K73-D060": "天悅邨",
    "K73-D070": "香港青年協會李秀紀紀念中學",
    "K73-D080": "美域花園",
    "K73-D090": "景湖庭",
    "K73-D100": "天慈邨",
    "K73-D110": "鳳池村",
    "K73-D120": "朗屏邨巴士總站",
    "K73-D130": "元朗盲人福利會",
    "K73-D140": "元朗(西)巴士總站"
  },
  "K74": {
    "K74-D010": "天水圍市中心",
    "K74-D020": "鍾基樓 天悅苑",
    "K74-D030": "天悅苑",
    "K74-D040": "天水圍巴士總站",
    "K74-D050": "天水圍公園",
    "K74-D060": "天慈邨",
    "K74-D070": "豐池村",
    "K74-D080": "龍坪邨巴士總站",
    "K74-D090": "元朗盲人院",
    "K74-D100": "元朗廣場",
    "K74-D110": "元朗地標",
    "K74-D120": "元朗站",
    "K74-D130": "博愛醫院",
    "K74-D140": "桐城",
    "K74-D150": "東華三院馬振玉紀念中學(龍善邨)",
    "K74-D160": "大橋村",
    "K74-D170": "圍頭學校",
    "K74-D180": "龍坪邨 楚平樓",
    "K74-D190": "龍坪邨巴士總站",
    "K74-D200": "豐池村",
    "K74-D210": "輕鐵 天慈站",
    "K74-D220": "天水圍公園",
    "K74-D230": "天水圍邨",
    "K74-D240": "天華邨",
    "K74-D250": "天悅邨",
    "K74-D260": "天水圍市中心"
  },
  "K76": {
    "K76-D010": "天恆邨巴士總站",
    "K76-D020": "天逸邨逸潭樓",
    "K76-D030": "天富苑富芙樓",
    "K76-D040": "天城苑",
    "K76-D050": "天水圍站巴士總站"
  }
};

const langSelect = document.getElementById("lang");
const routeSelect = document.getElementById("route");
const btnQuery = document.getElementById("btnQuery");
const statusDiv = document.getElementById("status");
const resultDiv = document.getElementById("result");
const footerRemark = document.getElementById("footerRemark");
let isQuerying = false;

function updateButtonState() {
  btnQuery.disabled = !routeSelect.value || isQuerying;
}

langSelect.addEventListener("change", updateButtonState);
routeSelect.addEventListener("change", updateButtonState);

btnQuery.addEventListener("click", async () => {
  const lang = langSelect.value;
  const route = routeSelect.value.trim();
  if (!route) return;

  isQuerying = true;
  updateButtonState();
  statusDiv.textContent = "正在查詢...";
  resultDiv.innerHTML = "";
  footerRemark.style.display = "none";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ language: lang, routeName: route })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    if (data.status !== "0" && data.status !== "1") throw new Error("API 狀態異常");

    renderResult(data, lang, route);
    statusDiv.textContent = `最後更新：${data.routeStatusTime || "—"}`;

    if (data.footerRemarks) {
      footerRemark.textContent = data.footerRemarks;
      footerRemark.style.display = "block";
    }
  } catch (err) {
    console.error(err);
    resultDiv.innerHTML = `<div class="error-msg">查詢失敗<br>${err.message}</div>`;
  } finally {
    isQuerying = false;
    updateButtonState();
  }
});

function getStopName(busStopId, selectedRoute) {
  const routeDict = STOP_NAMES[selectedRoute] || {};
  if (routeDict[busStopId]) return routeDict[busStopId];
  console.warn(`未知站點 ID: ${busStopId} (路線 ${selectedRoute})`);
  return `未知站點 (${busStopId})`;
}

function renderResult(data, lang, selectedRoute) {
  if (!data.busStop?.length) {
    resultDiv.innerHTML = '<p style="text-align:center">暫無站點資料</p>';
    return;
  }

  const isZh = lang === "zh";
  const title = isZh ? `路線 ${data.routeName} 到站時間` : `Route ${data.routeName} ETA`;

  let html = `<h2 class="route-title">${title}</h2>`;

  for (const stop of data.busStop) {
    const stopId = stop.busStopId || "—";
    const displayName = getStopName(stopId, selectedRoute);

    html += `<div class="bus-stop">
      <div class="stop-name">${displayName} <small>(${stopId})</small></div>`;

    if (!stop.bus?.length) {
      html += "<p>暫無巴士資料</p></div>";
      continue;
    }

    for (const bus of stop.bus) {
      const arrSec = Number(bus.arrivalTimeInSecond) || 999999;
      let timeDisplay = bus.arrivalTimeText || "—";

      if (arrSec >= 108000 || arrSec < 0) {
        timeDisplay = isZh ? "待定 / 沒有預計時間" : "TBC / No ETA";
      }

      const isSchedule = bus.isScheduled === "1";
      const timeClass = isSchedule ? "schedule" : "realtime";
      const directionHint = bus.lineRef?.includes("CIR") ? "(循環)" : "";

      html += `
        <div class="bus-item">
          <div class="bus-time">${timeDisplay}</div>
          <div class="bus-info">車牌：${bus.busId || "—"}　　${bus.lineRef || ""} ${directionHint}</div>
          <div class="${timeClass}">
            ${isSchedule ? (isZh ? "(班次)" : "(sched)") : (isZh ? "(實時)" : "(live)")}
          </div>
        </div>`;
    }
    html += "</div>";
  }

  resultDiv.innerHTML = html;
}

updateButtonState();
</script>
</body>
</html>
